<!DOCTYPE html>
<html lang="en-US" class="no-js"><head itemscope="itemscope" itemtype="http://schema.org/WebSite"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script><title>Configurare un Pi-Hole portatile - Blog un po' nerd</title><meta name="robots" content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Configurare un Pi-Hole portatile - Blog un po' nerd"><meta property="og:description" content="Poco tempo fa ho scoperto un progetto open source chiamato Pi-Hole, piuttosto conosciuto e apprezzato. Il compito di Pi-Hole è quello di “ripulire” la nostra navigazione su Internet da pubblicità e siti malevoli (semplificando: funge da ad-block), creando un piccolo server DNS sul Raspberry. Uno dei principali punti di forza è che, una volta configurato, … Continue reading Configurare un Pi-Hole portatile"><meta property="og:url" content="https://luigigubello.github.io/blog/configurare-pi-hole-portatile/"><meta property="og:site_name" content="Blog un po' nerd"><meta property="article:section" content="Italian"><meta property="article:published_time" content="2018-11-02T12:02:07+00:00"><meta property="article:modified_time" content="2018-11-03T18:10:12+00:00"><meta property="og:updated_time" content="2018-11-03T18:10:12+00:00"><meta property="og:image" content="https://luigigubello.github.io/blog/wp-content/uploads/2018/11/pihole_bibliografia.png"><meta name="twitter:card" content="summary"><meta name="twitter:description" content="Poco tempo fa ho scoperto un progetto open source chiamato Pi-Hole, piuttosto conosciuto e apprezzato. Il compito di Pi-Hole è quello di “ripulire” la nostra navigazione su Internet da pubblicità e siti malevoli (semplificando: funge da ad-block), creando un piccolo server DNS sul Raspberry. Uno dei principali punti di forza è che, una volta configurato, … Continue reading Configurare un Pi-Hole portatile"><meta name="twitter:title" content="Configurare un Pi-Hole portatile - Blog un po' nerd"><meta name="twitter:image" content="https://luigigubello.github.io/blog/wp-content/uploads/2018/11/pihole_bibliografia.png"><script type="application/ld+json" class="yoast-schema-graph yoast-schema-graph--main">{
    "@context": "https://schema.org",
    "@graph": [
        {
            "@type": "WebSite",
            "@id": "https://luigigubello.github.io/blog/#website",
            "url": "https://luigigubello.github.io/blog/",
            "name": "Blog un po' nerd",
            "inLanguage": "en-US",
            "description": "Nerd is the new Hipster",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://luigigubello.github.io/blog/?s={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        },
        {
            "@type": "ImageObject",
            "@id": "https://luigigubello.github.io/blog/configurare-pi-hole-portatile/#primaryimage",
            "inLanguage": "en-US",
            "url": "https://luigigubello.github.io/blog/wp-content/uploads/2018/11/pihole_bibliografia.png",
            "width": 300,
            "height": 300
        },
        {
            "@type": "WebPage",
            "@id": "https://luigigubello.github.io/blog/configurare-pi-hole-portatile/#webpage",
            "url": "https://luigigubello.github.io/blog/configurare-pi-hole-portatile/",
            "name": "Configurare un Pi-Hole portatile - Blog un po' nerd",
            "isPartOf": {
                "@id": "https://luigigubello.github.io/blog/#website"
            },
            "inLanguage": "en-US",
            "primaryImageOfPage": {
                "@id": "https://luigigubello.github.io/blog/configurare-pi-hole-portatile/#primaryimage"
            },
            "datePublished": "2018-11-02T12:02:07+00:00",
            "dateModified": "2018-11-03T18:10:12+00:00",
            "author": {
                "@id": "https://luigigubello.github.io/blog/#/schema/person/3e0819226c43d8f09f15276ee0bf80b3"
            }
        },
        {
            "@type": [
                "Person"
            ],
            "@id": "https://luigigubello.github.io/blog/#/schema/person/3e0819226c43d8f09f15276ee0bf80b3",
            "name": "luigi",
            "image": {
                "@type": "ImageObject",
                "@id": "https://luigigubello.github.io/blog/#authorlogo",
                "inLanguage": "en-US",
                "url": "http://0.gravatar.com/avatar/3cd96ff9c34c26a52f9873f52c72b268?s=96&d=mm&r=g",
                "caption": "luigi"
            },
            "sameAs": []
        }
    ]
}</script><link rel="dns-prefetch" href="//localhost"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//s.w.org"><link rel="stylesheet" id="wp-block-library-css" href="https://luigigubello.github.io/blog/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all"><link rel="stylesheet" id="munsa-lite-fonts-css" href="https://fonts.googleapis.com/css?family=Merriweather%3A300%2C400%2C700%2C900%2C300italic%2C400italic%2C700italic%2C900italic%7CMontserrat%3A400%2C700&subset=latin%2Clatin-ext" type="text/css" media="all"><link rel="stylesheet" id="genericons-css" href="https://luigigubello.github.io/blog/wp-content/themes/munsa-lite/fonts/genericons/genericons.css" type="text/css" media="all"><link rel="stylesheet" id="munsa-lite-style-css" href="https://luigigubello.github.io/blog/wp-content/themes/munsa-lite/style.css" type="text/css" media="all"><link rel="stylesheet" id="wp-social-sharing-css" href="https://luigigubello.github.io/blog/wp-content/plugins/wp-social-sharing/static/socialshare.css" type="text/css" media="all"><script type="text/javascript" src="https://luigigubello.github.io/blog/wp-includes/js/jquery/jquery.js"></script><script type="text/javascript" src="https://luigigubello.github.io/blog/wp-includes/js/jquery/jquery-migrate.min.js"></script><style type="text/css" id="custom-header-css">.site-title, .site-title a, .site-description, .site-description a { color: #000000 }</style><link rel="icon" href="https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-1-32x32.jpg" sizes="32x32"><link rel="icon" href="https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-1-192x192.jpg" sizes="192x192"><link rel="apple-touch-icon-precomposed" href="https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-1-180x180.jpg"><meta name="msapplication-TileImage" content="https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-1-270x270.jpg"><style type="text/css" id="wp-custom-css">
			/* Remove post summary from home page */

.home .entry-summary { display: none; }

		</style></head><body class="post-template-default single single-post postid-504 single-format-standard wp-custom-logo primary-menu-sidebar-active" itemscope="itemscope" itemtype="http://schema.org/Blog">

<div id="site-wrapper" class="site-wrapper">
	<div id="page" class="site">
	
	
	<div id="preloader" class="preloader">
		<div id="status" class="status">
			<span class="screen-reader-text">Site is loading</span>
			<div class="sk-three-bounce">
				<div class="sk-child sk-bounce1"></div>
				<div class="sk-child sk-bounce2"></div>
				<div class="sk-child sk-bounce3"></div>
			</div>
		</div>
	</div>
		
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
		
		
				
		<header id="masthead" class="site-header" role="banner" itemscope="itemscope" itemtype="http://schema.org/WPHeader"><div class="site-branding">
			
							
				<a href="https://luigigubello.github.io/blog/" class="custom-logo-link" rel="home"><img width="192" height="192" src="https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-2.jpg" class="custom-logo" alt="Blog un po' nerd" srcset="https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-2.jpg 192w,https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-2-150x150.jpg 150w,https://luigigubello.github.io/blog/wp-content/uploads/2017/12/cropped-favicon-2-125x125.jpg 125w" sizes="(max-width: 192px) 100vw, 192px"></a>			
									<p class="site-title" itemprop="headline"><a href="https://luigigubello.github.io/blog/" rel="home">Blog un po' nerd</a></p>
								
				<p class="site-description" itemprop="description">Nerd is the new Hipster</p>
			
							
			</div>
			
		</header><button id="menu-button" class="main-navigation-toggle menu-sidebar-toggle" aria-controls="menu-primary">Menu</button>

	<nav id="menu-primary" class="menu main-navigation menu-primary animated" role="navigation" aria-label="Primary Menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement"><button id="menu-close" class="main-navigation-toggle main-navigation-close menu-sidebar-close menu-sidebar-toggle" aria-controls="menu-primary">Close</button>

			<div class="wrap animated">
			
				<div class="primary-menu-container"><ul id="primary-menu" class="menu"><li id="menu-item-24" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-24"><a href="https://luigigubello.github.io/blog">Blog</a></li>
<li id="menu-item-16" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16"><a href="https://luigigubello.github.io/blog/about/">About</a></li>
<li id="menu-item-340" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-340"><a href="https://luigigubello.github.io/blog/cookie-policy/">Cookie Policy</a></li>
</ul></div>		
			</div>

	</nav><button id="sidebar-button" class="sidebar-primary-toggle menu-sidebar-toggle" aria-controls="sidebar-primary">Info</button>

	<aside id="sidebar-primary" class="sidebar-primary sidebar animated" role="complementary" itemscope="itemscope" itemtype="http://schema.org/WPSideBar"><h2 class="screen-reader-text" id="sidebar-primary-header">Primary Sidebar</h2>
		
		<button id="sidebar-close" class="sidebar-primary-toggle sidebar-primary-close menu-sidebar-close menu-sidebar-toggle" aria-controls="sidebar-primary">Close</button>
		
		<div class="wrap animated">
		
			<section id="search-5" class="widget widget_search"><form role="search" method="get" class="search-form" action="https://luigigubello.github.io/blog/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Search …" value="" name="s" title="Search for:"></label>
	<button type="submit" class="search-submit"><span class="screen-reader-text">Search</span></button>
</form>
</section></div>

	</aside><div id="content" class="site-content">
		
			<div id="primary" class="content-area">
				<main id="main" class="site-main" role="main"><article id="post-504" class="post-504 post type-post status-publish format-standard category-italian category-raspberry entry" itemscope="itemscope" itemtype="http://schema.org/BlogPosting" itemprop="blogPost"><header class="entry-header"><h1 class="entry-title" itemprop="headline">Configurare un Pi-Hole portatile</h1>			
	<div class="entry-meta">
		<span class="entry-date"><span class="screen-reader-text">Posted on </span><a href="https://luigigubello.github.io/blog/configurare-pi-hole-portatile/" rel="bookmark"><time class="entry-date" datetime="2018-11-02T13:02:07+01:00" itemprop="datePublished">2 November 2018</time></a></span><span class="byline"><span class="entry-author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><span class="screen-reader-text">Author </span><a class="entry-author-link" href="https://luigigubello.github.io/blog/author/luigi/" rel="author" itemprop="url"><span itemprop="name">luigi</span></a></span></span>			</div>
		</header><div class="entry-content" itemprop="articleBody">
			
			<p>Poco tempo fa ho scoperto un progetto open source chiamato <strong>Pi-Hole</strong>, piuttosto conosciuto e apprezzato. Il compito di Pi-Hole è quello di “ripulire” la nostra navigazione su Internet da pubblicità e siti malevoli (semplificando: funge da ad-block), creando un piccolo server DNS sul Raspberry. Uno dei principali punti di forza è che, una volta configurato, ripulisce dalle pubblicità ogni dispositivo connesso alla rete, senza bisogno di ulteriori programmi o plug-in.</p>
<p>Questo progetto mi ha entusiasmato così tanto (mi ha tolto la pubblicità invasiva e fastidiosa anche da tutte le applicazioni installate su Android) che ho deciso di provare a configurarlo in modo da portarlo facilmente in giro, senza bisogno di cavi ethernet o configurazioni particolari del router. Avendo anche un piccolo schermino da 3,5 pollici per il Raspberry l’ho configurato in modo tale che sul monitor appaiano alcune informazioni utili, ma questa è un’aggiunta superflua. Per configurare Pi-Hole come volevo ho usato:</p>
<ul><li>Raspberry Pi3 Model B + Raspbian Stretch Lite (2018-10-09)</li>
<li>‎TP Link TL-WN722N v3</li>
<li><a href="https://www.amazon.it/Raspberry-Quimat-Resolution-Protective-QSC11/dp/B06W55HBTX/ref=pd_sbs_147_2?_encoding=UTF8&pd_rd_i=B06W55HBTX&pd_rd_r=a0b0b9ae-de01-11e8-b659-c3ef5a38f9fa&pd_rd_w=gR58Z&pd_rd_wg=R8fgN&pf_rd_i=desktop-dp-sims&pf_rd_m=A11IL2PNWYJU7H&pf_rd_p=466c5af4-0171-4b17-9b3f-b4036a90f75d&pf_rd_r=3KT6KMEV303JBPPMNGBV&pf_rd_s=desktop-dp-sims&pf_rd_t=40701&psc=1&refRID=3KT6KMEV303JBPPMNGBV">Quimat LCD Display da 3,5 pollici</a> <strong>(opzionale)</strong></li>
</ul><h4 style="text-align: center;">1.</h4>
<p>Lo schermino LCD Quimat è opzionale, nel caso non si disponga di questo pezzo basta munirsi di classico cavo HDMI e monitor e saltare la parte della guida riguardante l’installazione dei driver per il display. La versione Lite di Raspbian si usa solo da linea di comando, quindi può essere utile avere una tastiera a portata di mano. Per prima cosa prepariamo una scheda SD estraendoci dentro Raspbian Lite, per fare ciò Balena Etcher (ex Etcher) andrà benissimo. A fine processo la memoria SD sarà divisa in due partizioni: <strong>boot</strong> e <strong>rootfs</strong>. Nella partizione <strong>boot</strong> creiamo due files: uno chiamato <strong>ssh</strong>, vuoto, e uno chiamato <strong>wpa_supplicant.conf</strong>. All’interno di quest’ultimo incollate il seguente testo, inserendo il nome della vostra connessione wi-fi e la password:<br><code><br>
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev<br>
update_config=1<br>
country=US</code><br><code><br>
network={<br>
    ssid="Your-WiFi-SSID"<br>
    psk="Your-WiFi-Password"<br>
    scan_ssid=1<br>
}</code></p>
<p>Questi due files ci serviranno per connetterci via SSH al Raspberry fin dal primo avvio. <a href="https://github.com/goodtft/LCD-show">Scarichiamo i driver</a> per il display Quimat, estraiamoli nella cartella <em>LCD-show</em>, e copiamo la cartella nella partizione <strong>rootfs</strong>, nel percorso <strong>/home/pi</strong>. Montiamo il display sul Raspberry e accendiamolo. Collegandoci via SSH diamo i seguenti comandi:<br><code><br>
chmod -R 755 LCD-show<br>
cd LCD-show<br>
sudo ./LCD35-show</code></p>
<p>Il Raspberry dovrebbe riavviarsi e sul display Quimat dovrebbe finalmente apparire la shell. Ora bisogna creare “ponte” tra l’antenna integrata del Raspberry (<em>wlan0</em>) e l’antenna WiFi USB (<em>wlan1</em>), per fare ciò basta seguire <a href="https://luigigubello.github.io/blog/utilizzare-il-raspberry-pi-3-via-termux/">questa</a> mia vecchia guida, ma utilizzando questa volta Raspbian Lite possiamo rinunciare all’installazione del pacchetto <em>network-manager-gnome</em>. La configurazione finale di Raspbian tramite <strong>raspi-config </strong>è lasciata all’utente, in base alle proprie abitudini e/o esigenze.</p>
<h4 style="text-align: center;">2.</h4>
<p>Ora è possibile installare Pi-Hole, diamo il seguente comando:<br><code><br>
curl -sSL https://install.pi-hole.net | bash</code></p>
<p>L’installazione è guidata e piuttosto facile, almeno per il momento conviene tenere le impostazioni di default, tranne per due configurazioni: quanto richiede l’interfaccia selezioniamo <strong>wlan0 </strong>e quando ci chiede quali IP utilizzare nella riga <em>IP Address</em> scriviamo <strong>192.168.12.1/24</strong> e nella riga <em>Gateway</em> scriviamo <strong>192.168.12.1</strong>. Concludiamo l’installazione e diamo infine il comando: <code>sudo apt-get purge dhcpcd5</code>.<br>
Quest’ultimo pacchetto viene installato in automatico da Pi-Hole ad ogni riconfigurazione che andremo a fare, e bisogno ricordarsi di toglierlo alla fine perché entra in conflitto con il pacchetto <em>network-manager</em>.</p>
<h4 style="text-align: center;">3.</h4>
<p><strong>Se non stai utilizzando uno schermo LCD puoi saltare questa parte.</strong> Per sfruttare al meglio il piccolo display Quimat ho deciso di usarlo in combinazione con <a href="https://github.com/jpmck/PADD">PADD</a>, un piccolo script che dà informazioni riguardo a Pi-Hole, che ho scoperto leggendo una <a href="https://learn.adafruit.com/pi-hole-ad-pitft-tft-detection-display/install-padd">guida</a> sul sito di Adafruit. Scarichiamo lo script: <code>wget -N https://raw.githubusercontent.com/jpmck/PADD/master/padd.sh</code>. Ora con <strong>nano </strong>andiamo a commentare la seguente riga:<br><code><br><strong>#</strong> export LC_ALL=en_US.UTF-8 > /dev/null 2>&1 || export LC_ALL=en_GB.UTF-8 > /dev/null 2>&1 || export LC_ALL=C.UTF-8 > /dev/null 2>&1</code></p>
<p>Per far avviare PADD ad ogni avvio di Raspbian modifichiamo il file <strong>.bashrc</strong> aggiungendo alla fine le seguenti righe:<br><code><br>
# Run PADD<br>
if [ "$TERM" == "linux" ] ; then<br>
  while :<br>
  do<br>
    ./padd.sh<br>
    sleep 1<br>
  done<br>
fi</code></p>
<p>E infine rendiamo eseguibile lo script: <code>chmod +x padd.sh</code>. Ora al prossimo riavvio PADD viene lanciato in automatico mostrando le informazioni relative a Pi-Hole.</p>
<h4 style="text-align: center;"><strong>4.</strong></h4>
<p>L’ultima parte riguarda la messa in sicurezza di Pi-Hole. L’idea è quella di poter portare il Raspberry facilmente in giro e di poter usufruire di Pi-Hole anche su reti che non sono la nostra, come ad esempio il wi-fi di un albergo. Per prima cosa quindi bisogna cambiare la password di Raspbian e quella del pannello di controllo di Pi-Hole (<em>pi.hole/admin/</em>). Il Raspberry ora dovrebbe funzionare più o meno così:</p>
<p style="text-align: center;"><strong>[device]–>[raspberry][wlan0]–>[wlan1][/raspberry]–>[router]</strong></p>
<p>Pi-Hole è impostato su <em>wlan0</em>, che fa da hotspot, e <em>wlan1</em> viene utilizzata per connettersi ai vari router. Quindi bisogna fare in modo che:</p>
<ol><li>I dispositivi che si connettono a <em>wlan0</em> non abbiano accesso non autorizzatto alla pagina <em>pi.hole/admin/</em>.</li>
<li>Il Raspberry non sia esposto a particolari rischi quando si connette a un router tramite <em>wlan1</em>.</li>
</ol><p>Configuriamo quindi <strong>lighttpd</strong> in modo tale che vengano richiesti <em>user</em> e <em>password</em> per accedere a <em>pi.hole/admin/</em> e che l’accesso a questa pagina sia ristretto solo a determinati IP (cioè solo agli utenti connessi a <em>wlan0</em>). Nella cartella <strong>/etc/lighttpd</strong> modifichiamo (o creiamo, nel caso non esistesse) il file <strong>external.conf</strong>, aggiungendo queste righe:<br><code><br>
$HTTP["remoteip"] != "192.168.12.1/24" {<br>
  url.access-deny = ( "" )<br>
}</code></p>
<p>Ora controlliamo che nel file <strong>lighttpd.conf</strong> siano presente le seguenti righe, altrimenti bisogna aggiungerle alla fine del file:<br><code><br>
# Add user chosen options held in external file<br>
include_shell "cat external.conf 2>/dev/null"</code></p>
<p>A questo punto solo gli IP <strong>192.168.12.*</strong> avranno accesso alla pagina <em>pi.hole</em>. Ora aggiungiamo una richiesta di autenticazione, per fare ciò ho seguito una <a href="https://jacobsalmela.com/2014/05/25/password-protect-a-lighttpd-web-server-on-a-raspberry-pi-using-mod-auth/">semplice guida</a> di <a href="https://jacobsalmela.com">Jacob Salmela</a>. Per prima cosa creiamo in <em>/etc/lighttpd/</em> una cartella chiamata <strong>.htpasswd</strong>: <code>sudo mkdir /etc/lighttpd/.htpasswd</code>. All’interno di questa cartella creiamo lo script <strong>hash.sh </strong>contenente il seguente codice:<br><code><br>
#!/bin/sh<br>
user=$1<br>
realm=$2<br>
pass=$3<br>
hash=`echo -n "$user:$realm:$pass" | md5sum | cut -b -32`<br>
echo "$user:$realm:$hash"</code></p>
<p>Rendiamo eseguibile lo script e lanciamolo, scegliendo un nome utente e una password al posto di <strong>user</strong> e <strong>password</strong>.<br><code><br>
sudo chmod +x hash.sh<br>
sudo ./hash.sh '<strong>user</strong>' 'pihole' '<strong>password</strong>'</code></p>
<p>Lo script restituirà una stringa come output, copiamola e incolliamola in un nuovo file chiamato <strong>lighttpd-htdigest.user</strong>, che va salvato sempre nella cartella <strong>./htpasswd</strong>. Infine apriamo nuovamente <em>lighttpd.conf </em>e incolliamo il seguente testo:<br><code><br>
# Mod_Auth Configuration<br>
auth.backend = "htdigest"<br>
auth.backend.htdigest.userfile = "/etc/lighttpd/.htpasswd/lighttpd-htdigest.user"<br>
auth.require = ( "/admin/" =><br>
    (<br>
    "method"  => "digest",<br>
    "realm"   => "pihole",<br>
    "require" => "user=<strong>user</strong>"<br>
    ),<br>
)</code></p>
<p>Al posto di <strong>user</strong> bisogna inserire il nome utente usato nel file <strong>lighttpd-htdigest.user</strong>, salviamo il file e riavviamo lighttpd: <code>sudo service lighttpd restart</code>. Ora per accedere alla pagina <em>pi.hole</em> dovrebbero venirci richiesti user e password. Se tutto è andato per il verso giusto , occupiamoci di restringere l’accesso al protocollo SSH. Apriamo il file <strong>/etc/ssh/sshd_config </strong>e aggiungiamo le seguenti righe:<br><code><br>
# Block all users except from 192.168.12.*<br>
AllowUsers *@192.168.12.*</code></p>
<p>Così facendo solo gli utenti con IP <strong>192.168.12.*</strong> (cioè quelli connessi a <em>wlan0</em>) potranno connettersi via SSH al Raspberry.<br>
Adesso bisogna bloccare in entrata le porte <strong>22</strong> e <strong>53</strong> dell’antenna <em>wlan1</em>, che è quella che espone il Raspberry a potenziali minacce collegandosi a router estranei. Dirigiamoci nella directory <strong>/home/pi/ </strong>e digitiamo i seguenti comandi:<br><code><br>
sudo apt-get install iptables-persistent<br>
mkdir iptables && cd iptables<br>
sudo iptables-save > /home/pi/iptables/iptables<br>
cp iptables iptables.orig</code></p>
<p>Ora apriamo con <em>nano</em> il file <em>iptables </em>e aggiungiamo le seguenti regole per rifiutare il traffico in entrata sulle porte 22 e 53 su <em>wlan1</em>:<br><code><br>
-A INPUT -i wlan1 -p tcp --destination-port 22 -j REJECT<br>
-A INPUT -i wlan1 -p tcp --destination-port 53 -j REJECT</code></p>
<p>Ora importiamo le nuove regole e impostiamo che vengano usate ad ogni avvio, diamo quindi i seguenti comandi:<br><code><br>
sudo iptables-restore /home/pi/iptables/iptables<br>
cd /etc/network/if-pre-up.d<br>
sudo nano iptables</code></p>
<p>All’interno di questo nuovo file <em>iptables</em> inseriamo il seguente codice (grazie <a href="https://wiki.debian.org/it/iptables">Debian Wiki</a> ❤):<br><code><br>
#!/bin/sh<br>
/sbin/iptables-restore < /home/pi/iptables/iptables</code></p>
<p>Per ultimare rendiamo eseguibile lo script e riavviamo: <code>sudo chmod +x iptables && sudo reboot</code>. Dopo il riavvio colleghiamo il Raspberry, tramite comando <b>nmcli</b>, al router di casa (o a un router qualsiasi in realtà) e controlliamo che le porte 22 e 53 non siano visibili (per farlo basta collegare un telefono Android al medesimo router e con <em>Termux</em> dare il comando <code>nmap <em><ip_raspberry></em></code>).</p>
<p>A questo punto la configurazione è praticamente ultimata, ma per scrupolo andremo a creare un <strong>certificato SSL</strong> per la pagina web <em>pi.hole</em>. Essendo la pagina <em>pi.hole</em> raggiungibile solamente se si è collegati a <em>wlan0</em> ho deciso che un certificato autofirmato è sufficiente, visto che siamo noi stessi a crearlo possiamo reputarlo attendibile. Chrome e Firefox (e presumo ogni altro browser) non lo reputeranno tale perché noteranno che è autofirmato e non è certificato da nessun ente terzo, questo non è un problema, come viene spiegato anche nella <a href="https://support.mozilla.org/it/kb/questa-connessione-non-sicura#w_il-certificato-non-ae-affidabile-in-quanto-auto-firmato">pagina di supporto di Mozilla</a>, e basta aggiungerlo tra le eccezioni. Dirigiamoci nella directory <strong>/etc/lighttpd </strong>e diamo i seguenti comandi:<br><code><br>
sudo mkdir certs && cd certs<br>
sudo openssl req -new -x509 -keyout pihole.pem -out pihole.pem -days 365 -nodes</code></p>
<p>Potete lasciare vuoti tutti i campi eccetto quello chiamato <strong>Common Name</strong> in cui dovrete inserire <strong>pi.hole</strong>, infine date il seguente comando: <code>sudo chmod 400 pihole.pem</code>. Ora torniamo nella cartella<strong>/etc/lighttpd</strong> e modifichiamo il file <strong>lighttpd.conf</strong> aggiungendo il seguente testo:<br><code><br>
# Enable certificate SSL<br>
$SERVER["socket"] == ":443" {<br>
  ssl.engine = "enable"<br>
  ssl.pemfile =  "/etc/lighttpd/certs/pihole.pem"<br>
}</code><br><code><br>
# Redirect HTTP to HTTPS<br>
$HTTP["scheme"] == "http" {<br>
  $HTTP["host"] =~ ".*" {<br>
    url.redirect = (".*" => "https://%0$0")<br>
  }<br>
}</code></p>
<p>Perfetto, ora riavviamo <em>lighttpd</em> come fatto in precedenza. A questo punto tutto dovrebbe essere filato per il verso giusto, quindi facciamo un backup di alcuni files:<br><code><br>
sudo cp /etc/lighttpd/lighttpd.conf /etc/lighttpd/lighttpd.conf.bk<br>
cp /home/pi/iptables/iptables /home/pi/iptables/iptables.bk</code></p>
<p>E riavviamo. <em>That’s all folks!</em></p>
<p>Lascio un QR code contenente tutti i post, le discussioni, le guide e le varie letture che mi sono tornate utili per configurare il tutto.</p>
<p><img class="aligncenter wp-image-523" src="https://luigigubello.github.io/blog/wp-content/uploads/2018/11/pihole_bibliografia.png" alt="" width="200" height="200" srcset="https://luigigubello.github.io/blog/wp-content/uploads/2018/11/pihole_bibliografia.png 300w,https://luigigubello.github.io/blog/wp-content/uploads/2018/11/pihole_bibliografia-150x150.png 150w,https://luigigubello.github.io/blog/wp-content/uploads/2018/11/pihole_bibliografia-125x125.png 125w" sizes="(max-width: 200px) 100vw, 200px"></p>
		<div class="social-sharing ss-social-sharing">
				        <a onclick="return ss_plugin_loadpopup_js(this);" rel="external nofollow" class="ss-button-facebook" href="http://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%2Fblog%2Fconfigurare-pi-hole-portatile%2F" target="_blank">Share on Facebook</a><a onclick="return ss_plugin_loadpopup_js(this);" rel="external nofollow" class="ss-button-twitter" href="http://twitter.com/intent/tweet/?text=Configurare+un+Pi-Hole+portatile&url=http%3A%2F%2Flocalhost%2Fblog%2Fconfigurare-pi-hole-portatile%2F" target="_blank">Share on Twitter</a><a onclick="return ss_plugin_loadpopup_js(this);" rel="external nofollow" class="ss-button-linkedin" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%2Fblog%2Fconfigurare-pi-hole-portatile%2F&title=Configurare+un+Pi-Hole+portatile" target="_blank">Share on Linkedin</a>	        	    </div>
	    
						
		</div>
		
		<footer class="entry-footer"><div class="footer-wrap">
								<div class="entry-categories"><span class="terms-title categories-title">Categories</span><span class="entry-terms category" itemprop="articleSection">#<a href="https://luigigubello.github.io/blog/category/italian/" rel="tag">Italian</a> #<a href="https://luigigubello.github.io/blog/category/raspberry/" rel="tag">Raspberry</a></span></div>							</div>
		</footer></article><nav class="navigation post-navigation" role="navigation" aria-label="Posts"><h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://luigigubello.github.io/blog/italian-hacker-camp-2018/" rel="prev"><span class="meta-nav" aria-hidden="true">Previous</span> <span class="screen-reader-text">Previous post:</span> <span class="post-title">Italian Hacker Camp 2018</span></a></div><div class="nav-next"><a href="https://luigigubello.github.io/blog/about-iran-and-ira-twitter-datasets-for-fun-part-one/" rel="next"><span class="meta-nav" aria-hidden="true">Next</span> <span class="screen-reader-text">Next post:</span> <span class="post-title">About Iran and IRA Twitter datasets (for fun) – Part I</span></a></div></div>
	</nav></main></div>
		
		</div>
		
				
		
		
		<footer id="colophon" class="site-footer" role="contentinfo" itemscope="itemscope" itemtype="http://schema.org/WPFooter"><div class="site-info">
				<a href="https://wordpress.org/">Proudly powered by WordPress</a>
				<span class="sep"> | </span>
				Theme: Munsa Lite by <a href="https://foxland.fi/">Foxland</a>.			</div>
			
			
				
			<a href="#site-wrapper" id="scroll-up" class="scroll-up" data-scroll><span class="scroll-up-wrapper">Back to top</span></a>
		
		</footer></div>
	
</div>

<script type="text/javascript" src="https://luigigubello.github.io/blog/wp-content/themes/munsa-lite/js/smooth-scroll.min.js"></script><script type="text/javascript">
/* <![CDATA[ */
var MunsaLiteScreenReaderText = {"expandMenu":"Menu","collapseMenu":"Close","expandSidebar":"Info","collapseSidebar":"Close"};
/* ]]> */
</script><script type="text/javascript" src="https://luigigubello.github.io/blog/wp-content/themes/munsa-lite/js/settings.min.js"></script><script type="text/javascript" src="https://luigigubello.github.io/blog/wp-content/themes/munsa-lite/js/skip-link-focus-fix.min.js"></script><script type="text/javascript" src="https://luigigubello.github.io/blog/wp-content/plugins/wp-social-sharing/static/socialshare.js"></script></body></html>
